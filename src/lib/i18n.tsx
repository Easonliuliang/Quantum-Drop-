import {
  createContext,
  ReactNode,
  useCallback,
  useContext,
  useEffect,
  useMemo,
  useState,
} from "react";

type Messages = Record<string, string>;
type TranslateParams = Record<string, string | number>;

type I18nContextValue = {
  locale: string;
  setLocale: (next: string) => void;
  t: (key: string, fallback?: string, params?: TranslateParams) => string;
};

const DEFAULT_LOCALE = "zh-CN";
const LOCALE_STORAGE_KEY = "qd_locale";

const DEFAULT_MESSAGES: Record<string, Messages> = {
  "zh-CN": {
    "app.title": "Quantum Drop · 量子快传",
    "settings.title": "设置",
    "settings.myCode": "我的码",
    "settings.tapToCopy": "点击复制",
    "settings.generating": "生成中...",
    "settings.addFriend": "添加好友",
    "settings.scanQR": "扫描二维码",
    "settings.orEnterCode": "或输入码",
    "settings.add": "添加",
    "settings.friends": "好友",
    "settings.linkDevice": "关联设备",
    "settings.showDeviceCode": "显示我的设备码",
    "settings.orEnterDeviceCode": "或输入其他设备的码",
    "settings.link": "关联",
    "settings.transfer": "传输",
    "settings.recentLogs": "最近日志",
    "settings.copied": "已复制！",
    "settings.deviceCodeExpires": "你的设备码（5分钟后过期）",
    "settings.codeCopied": "码已复制！",
    "hero.tagline": "轻松拖拽，极速直达。",
    "hero.selectFiles": "选择文件",
    "dropzone.label": "拖拽或选择文件上传",
    "filePanel.title": "已准备传输的文件",
    "filePanel.start": "启动传输",
    "filePanel.starting": "启动中…",
    "receive.heading": "接收（同网模式）",
    "receive.tab.code": "配对码",
    "receive.tab.scan": "扫描",
    "receive.tab.manual": "手动",
    "receive.instructions": "输入 6 位配对码，应用会自动发现发送方。",
    "receive.disabled.title": "接收",
    "receive.disabled.description": "当前构建暂未启用接收功能，可在事件日志中右键下载或等待桌面端更新。",
    "receive.disabled.note": "后续桌面版本会恢复安全接收流程。",
    "panel.stats": "传输统计",
    "panel.audit": "操作审计",
    "panel.settings": "传输设置",
    "panel.security": "安全策略",
    "panel.trusted": "已信任设备",
    "panel.statsError": "无法加载传输统计，请刷新重试。",
    "panel.auditError": "无法加载审计日志，请刷新重试。",
    "panel.settingsError": "无法加载传输设置，请刷新重试。",
    "panel.securityError": "无法加载安全策略，请刷新重试。",
    "panel.trustedError": "无法加载信任列表，请刷新。",
    "actions.refresh": "刷新",
    "actions.refreshing": "更新中…",
    "actions.syncLicense": "刷新权益",
    "actions.syncingLicense": "同步权益…",
    "actions.syncAudit": "刷新",
    "actions.syncingAudit": "同步中…",
    "actions.activate": "激活 License",
    "actions.activating": "激活中…",
    "actions.copySample": "复制示例",
    "actions.copy": "复制",
    "info.logsCopied": "最近日志已复制。",
    "info.noTrustedDevices": "当前没有已信任的设备。",
    "info.sampleLicenseCopied": "示例 License Key 已复制。",
    "info.routeTauriOnly": "路由统计仅在 Tauri 桌面端可用。",
    "info.routeInvokeMissing": "Tauri invoke API 不可用，无法获取路由统计。",
    "info.routeEmpty": "暂无路由统计数据。",
    "info.statsTauriOnly": "传输统计仅在 Tauri 桌面端可用。",
    "info.statsInvokeMissing": "Tauri invoke API 不可用，无法获取传输统计。",
    "info.auditTauriOnly": "审计日志仅在 Tauri 桌面端可用。",
    "info.auditInvokeMissing": "Tauri invoke API 不可用，无法获取审计日志。",
    "info.licenseTauriOnly": "权益信息仅在 Tauri 桌面端可用。",
    "info.licenseInvokeMissing": "Tauri invoke API 不可用，无法获取权益信息。",
    "info.securityTauriOnly": "安全策略仅在 Tauri 桌面端可查询。",
    "info.securityInvokeMissing": "Tauri invoke API 不可用，无法读取安全策略。",
    "info.settingsTauriOnly": "传输设置仅在 Tauri 桌面端可调整。",
    "info.settingsInvokeMissing": "Tauri invoke API 不可用，无法获取传输设置。",
    "info.settingsSaved": "传输设置已保存。",
    "info.activateTauriOnly": "License 激活需在 Tauri 桌面端运行。",
    "info.activateNeedIdentity": "请先注册或导入身份，再激活 License。",
    "info.licenseActivated": "License 激活成功。",
    "info.identityTauriOnly": "身份注册需在 Tauri 桌面环境完成。",
    "info.identityRegistered": "身份 {id} 已注册。",
    "info.deviceRegisterTauriOnly": "设备登记需在 Tauri 桌面环境完成。",
    "info.needIdentity": "请先注册身份。",
    "info.entitlementTauriOnly": "权益升级需在 Tauri 桌面环境完成。",
    "info.noPrivateKey": "当前无可导出的身份私钥。",
    "info.privateKeyCopied": "已复制私钥到剪贴板，请妥善保管。",
    "info.identityImported": "身份 {id} 导入成功。",
    "info.dialogMissing": "未检测到 Tauri 对话框插件，已使用系统文件选择器。",
    "info.dialogFallback": "文件选择器已回退为浏览器模式。",
    "info.browserPreview": "浏览器模式仅展示 UI，传输需在 Tauri 桌面环境运行。",
    "info.transferDesktopOnly": "模拟传输需在 Tauri 桌面端运行。",
    "info.needIdentityDetailed": "请先创建或导入量子身份。",
    "info.needDevice": "请至少登记一个终端设备。",
    "info.needFile": "请选择至少一个文件。",
    "info.needDirectoryDesktop": "请选择保存目录（仅支持桌面端）。",
    "info.directoryPluginMissing": "未检测到目录选择插件，请手动输入路径。",
    "info.receiveTauriOnly": "接收功能需在 Tauri 桌面端运行。",
    "info.enterPairingCode": "请输入 6 位配对码。",
    "info.enterSenderIp": "请输入发送方 IP 地址。",
    "info.enterPort": "请输入合法端口（1-65535）。",
    "info.enterSenderKey": "请输入发送方公钥。",
    "info.senderKeyLength": "公钥长度必须为 64 位十六进制。",
    "info.chooseDirectory": "请选择保存目录。",
    "info.enterFingerprint": "请输入发送方证书指纹。",
    "info.receiveInvokeMissing": "Tauri invoke API 不可用，无法启动接收。",
    "info.scanTauriOnly": "扫描需在 Tauri 桌面端运行。",
    "info.scanInvokeMissing": "Tauri invoke API 不可用，无法扫描发送方。",
    "info.webrtcTauriOnly": "WebRTC 测试需在 Tauri 桌面端运行。",
    "info.needIdentityInitialized": "请先完成身份初始化。",
    "info.needFileForWebrtc": "请选择至少一个文件再尝试 WebRTC 发送。",
    "info.webrtcInvokeMissing": "未检测到 Tauri invoke API，无法启动 WebRTC 测试。",
    "info.webrtcSenderStarted": "已启动 WebRTC 发送测试，等待接收方加入。",
    "info.needPairingForWebrtc": "请输入配对码再启动 WebRTC 接收。",
    "info.webrtcReceiverStarted": "已启动 WebRTC 接收测试，等待发送方。",
    "info.deviceUpdateTauriOnly": "终端信息更新仅在 Tauri 桌面环境可用。",
    "info.fieldCopied": "{field} 已复制到剪贴板。",
    "info.deviceUpdated": "终端信息已更新。",
    "info.syncTauriOnly": "刷新同频需在桌面端运行。",
    "info.noIdentityToRemove": "暂无可移除的身份。",
    "info.identityRemoved": "身份已从本机移除，下次启动需重新导入。",
    "info.transferComplete": "传输完成，PoT 证明已生成。",
    "license.current": "当前权益",
    "license.quota": "跨网配额",
    "license.quotaUsage": "已用 {used} / {quota} 次",
    "license.empty": "暂无权益信息，请刷新后重试。",
    "license.placeholder": "输入 License Key，例如 QD-PRO-XXXX-YYYY",
    "stats.emptyTransfers": "暂无传输记录。",
    "audit.empty": "暂无审计记录。",
    "settings.security.signature": "签名校验",
    "settings.security.enabledRecommended": "已启用（推荐）",
    "settings.security.disabled": "未启用",
    "settings.security.disconnect": "验签失败断开",
    "settings.security.disconnect.strict": "失败即断开",
    "settings.security.disconnect.warn": "失败仅警告",
    "settings.security.audit": "审计日志",
    "settings.security.audit.enabled": "记录到本地 SQLite",
    "settings.security.audit.disabled": "未记录",
    "settings.security.empty": "无法读取安全策略，请刷新或检查配置。",
    "trusted.clear": "清空",
    "trusted.unknownFingerprint": "未知指纹",
    "trusted.status.verified": "签名通过",
    "trusted.status.manual": "手动信任",
    "trusted.remove": "移除",
    "settings.chunk.adaptive": "自适应 Chunk",
    "settings.chunk.min": "最小 Chunk (MiB)",
    "settings.chunk.max": "最大 Chunk (MiB)",
    "settings.chunk.streams": "LAN 并发流数",
    "settings.chunk.help": "根据网络质量自动调整 Chunk，推荐开启。",
    "settings.chunk.save": "保存设置",
    "settings.chunk.saving": "保存中…",
    "settings.chunk.empty": "暂无设置数据，请刷新或稍后重试。",
    "locale.label": "界面语言",
    "locale.zh": "中文",
    "locale.en": "English",
    "nav.send": "发送文件",
    "nav.receive": "接收文件",
    "nav.identity": "身份管理",
    "nav.transfer": "传输状态",
    "nav.webrtc": "跨网实验",
    "nav.logs": "事件日志",
    "nav.control": "控制面板",
    "transfer.tab.basic": "基础信息",
    "transfer.tab.monitor": "实时监控",
    "transfer.tab.stats": "统计数据",
    "transfer.tab.audit": "审计日志",
    "transfer.tab.security": "安全策略",
    "transfer.tab.settings": "高级设置",
    "control.transferHeading": "传输状态",
    "control.transferEmpty": "当前没有进行中的传输。",
    "control.logsHeading": "事件日志",
    "control.logsEmpty": "暂无日志输出。",
    "identity.heading": "身份与设备",
    "identity.identityLabel": "身份标识",
    "identity.primaryKey": "主公钥",
    "identity.empty": "尚未注册身份，点击“创建主身份”即可生成量子身份。",
    "identity.activeDevice": "当前终端：{name}",
    "identity.browserHint": "当前运行在浏览器预览模式，身份相关操作会提示如何在桌面端执行。",
    "identity.actions.createPrimary": "创建主身份",
    "identity.actions.creating": "创建中…",
    "identity.actions.registerDevice": "登记新设备",
    "identity.actions.registering": "登记中…",
    "identity.actions.export": "导出私钥",
    "identity.actions.forget": "忘记当前身份",
    "identity.actions.forgetting": "移除中…",
    "identity.actions.sync": "刷新同频",
    "identity.actions.upgrade": "升级 PRO",
    "identity.actions.downgrade": "降级为 Free",
    "identity.actions.updating": "更新中…",
    "identity.import.idPlaceholder": "身份标识",
    "identity.import.keyPlaceholder": "私钥十六进制",
    "identity.import.submit": "导入身份",
    "identity.import.submitting": "导入中…",
    "identity.entitlement.label": "当前权益",
    "identity.entitlement.plan.free": "free",
    "identity.entitlement.plan.pro": "pro",
    "identity.entitlement.plan.enterprise": "enterprise",
    "identity.devices.empty": "暂无已登记设备。",
    "identity.devices.emptyNoIdentity": "创建身份后可在此查看设备列表。",
    "identity.devices.lastSeen": "上次心跳 {time}",
    "identity.devices.capabilities": "能力 {list}",
    "identity.devices.activeFlag": "当前终端",
    "identity.device.section": "终端设置",
    "identity.device.nameLabel": "终端名称",
    "identity.device.namePlaceholder": "例如：工作站、笔电",
    "identity.device.statusLabel": "终端状态",
    "identity.device.status.active": "active · 在线",
    "identity.device.status.standby": "standby · 待命",
    "identity.device.status.inactive": "inactive · 停用",
    "identity.device.save": "保存终端信息",
    "identity.device.saving": "保存中…",
    "identity.device.setStandby": "设为待命",
    "identity.device.markInactive": "标记为停用",
    "identity.device.hint": "更新操作会生成签名并提交 auth_update_device，保持设备名称统一方便在多设备间切换。",
    "webrtc.heading": "WebRTC 跨网实验（阶段三）",
    "webrtc.hint": "发送端会在缺少配对码时自动生成 6 位随机码，接收端沿用上方“接收”面板中的配对码与保存目录。该功能目前为实验性质，仅验证 P2P 信令链路。",
    "webrtc.startSender": "启动 WebRTC 发送",
    "webrtc.senderStarting": "WebRTC 发送启动中…",
    "webrtc.startReceiver": "启动 WebRTC 接收",
    "webrtc.receiverStarting": "WebRTC 接收等待中…",
    "webrtc.receiverDisabled": "当前版本暂停 WebRTC 接收测试，请在发送后通过控制面板下载文件。",
    "stats.totalTransfers": "总传输次数",
    "stats.totalBytes": "传输总量",
    "stats.successRate": "成功率",
    "stats.successFailure": "成功 {succ} · 失败 {fail}",
    "receive.panel.title": "接收文件",
    "receive.panel.codeSection": "配对码",
    "receive.panel.connect": "连接",
    "receive.panel.connecting": "连接中…",
    "receive.panel.nearby": "附近设备",
    "receive.panel.bleDevice": "BLE 设备",
    "receive.panel.noDevices": "暂无发现附近 BLE 设备",
    "receive.panel.connectSuccess": "已连接，准备接收…",
    "receive.panel.connectError": "连接失败：{error}",
  },
  en: {
    "app.title": "Quantum Drop",
    "settings.title": "Settings",
    "settings.myCode": "My Code",
    "settings.tapToCopy": "Tap to copy",
    "settings.generating": "Generating...",
    "settings.addFriend": "Add Friend",
    "settings.scanQR": "Scan QR Code",
    "settings.orEnterCode": "or enter code",
    "settings.add": "Add",
    "settings.friends": "Friends",
    "settings.linkDevice": "Link Device",
    "settings.showDeviceCode": "Show My Device Code",
    "settings.orEnterDeviceCode": "or enter code from another device",
    "settings.link": "Link",
    "settings.transfer": "Transfer",
    "settings.recentLogs": "Recent Logs",
    "settings.copied": "Copied!",
    "settings.deviceCodeExpires": "Your device code (expires in 5 min)",
    "settings.codeCopied": "Code copied!",
    "hero.tagline": "Drag & drop files, transfer instantly.",
    "hero.selectFiles": "Select Files",
    "dropzone.label": "Drag or choose files to upload",
    "filePanel.title": "Files queued for transfer",
    "filePanel.start": "Start transfer",
    "filePanel.starting": "Starting…",
    "receive.heading": "Receive (LAN Mode)",
    "receive.tab.code": "Code",
    "receive.tab.scan": "Scan",
    "receive.tab.manual": "Manual",
    "receive.instructions": "Enter the 6-digit code and we will auto-discover the sender.",
    "receive.disabled.title": "Receive",
    "receive.disabled.description": "Receiving is disabled in this build. Download files directly from the sender or from Event Logs.",
    "receive.disabled.note": "Secure receiving will return in a future desktop release.",
    "panel.stats": "Transfer Statistics",
    "panel.audit": "Audit Log",
    "panel.settings": "Transfer Settings",
    "panel.security": "Security Policies",
    "panel.trusted": "Trusted Devices",
    "panel.statsError": "Unable to load transfer stats. Please refresh.",
    "panel.auditError": "Audit log unavailable. Please refresh.",
    "panel.settingsError": "Unable to load transfer settings. Please refresh.",
    "panel.securityError": "Unable to load security policies. Please refresh.",
    "panel.trustedError": "Trusted devices unavailable. Please refresh.",
    "actions.refresh": "Refresh",
    "actions.refreshing": "Refreshing…",
    "actions.syncLicense": "Sync license",
    "actions.syncingLicense": "Syncing…",
    "actions.syncAudit": "Refresh",
    "actions.syncingAudit": "Syncing…",
    "actions.activate": "Activate License",
    "actions.activating": "Activating…",
    "actions.copySample": "Copy Sample",
    "actions.copy": "Copy",
    "info.logsCopied": "Recent logs copied.",
    "info.noTrustedDevices": "No trusted devices yet.",
    "info.sampleLicenseCopied": "Sample License Key copied.",
    "info.routeTauriOnly": "Route metrics are only available in the desktop app.",
    "info.routeInvokeMissing": "Tauri invoke API unavailable, cannot load route metrics.",
    "info.routeEmpty": "No route metrics yet.",
    "info.statsTauriOnly": "Transfer statistics are only available in the desktop app.",
    "info.statsInvokeMissing": "Tauri invoke API unavailable, cannot load transfer statistics.",
    "info.auditTauriOnly": "Audit logs are only available in the desktop app.",
    "info.auditInvokeMissing": "Tauri invoke API unavailable, cannot load audit logs.",
    "info.licenseTauriOnly": "License info is only available in the desktop app.",
    "info.licenseInvokeMissing": "Tauri invoke API unavailable, cannot load license info.",
    "info.securityTauriOnly": "Security policies are only available in the desktop app.",
    "info.securityInvokeMissing": "Tauri invoke API unavailable, cannot load security policies.",
    "info.settingsTauriOnly": "Transfer settings are only available in the desktop app.",
    "info.settingsInvokeMissing": "Tauri invoke API unavailable, cannot load transfer settings.",
    "info.settingsSaved": "Transfer settings saved.",
    "info.activateTauriOnly": "License activation is only available in the desktop app.",
    "info.activateNeedIdentity": "Register or import an identity before activating a license.",
    "info.licenseActivated": "License activated.",
    "info.identityTauriOnly": "Identity registration is only available in the desktop app.",
    "info.identityRegistered": "Identity {id} registered.",
    "info.deviceRegisterTauriOnly": "Device registration is only available in the desktop app.",
    "info.needIdentity": "Please register an identity first.",
    "info.entitlementTauriOnly": "Plan upgrades are only available in the desktop app.",
    "info.noPrivateKey": "No private key available to export.",
    "info.privateKeyCopied": "Private key copied to clipboard. Keep it safe.",
    "info.identityImported": "Identity {id} imported successfully.",
    "info.dialogMissing": "Tauri dialog plugin missing. Used system file selector.",
    "info.dialogFallback": "File picker fell back to browser mode.",
    "info.browserPreview": "Browser preview only shows the UI. Please use the desktop app for transfers.",
    "info.transferDesktopOnly": "Simulated transfer requires the desktop app.",
    "info.needIdentityDetailed": "Create or import an identity first.",
    "info.needDevice": "Please register at least one device.",
    "info.needFile": "Please select at least one file.",
    "info.needDirectoryDesktop": "Choose a save directory (desktop only).",
    "info.directoryPluginMissing": "Directory picker plugin missing, please enter the path manually.",
    "info.receiveTauriOnly": "Receiving requires the desktop app.",
    "info.enterPairingCode": "Enter the 6-digit pairing code.",
    "info.enterSenderIp": "Enter the sender IP.",
    "info.enterPort": "Enter a valid port (1-65535).",
    "info.enterSenderKey": "Enter the sender public key.",
    "info.senderKeyLength": "Public key must be 64 hex characters.",
    "info.chooseDirectory": "Please choose a save directory.",
    "info.enterFingerprint": "Enter the sender certificate fingerprint.",
    "info.receiveInvokeMissing": "Tauri invoke API unavailable, cannot start receive.",
    "info.scanTauriOnly": "Discovery is only available in the desktop app.",
    "info.scanInvokeMissing": "Tauri invoke API unavailable, cannot scan senders.",
    "info.webrtcTauriOnly": "WebRTC tests require the desktop app.",
    "info.needIdentityInitialized": "Complete identity setup first.",
    "info.needFileForWebrtc": "Select at least one file before starting WebRTC send.",
    "info.webrtcInvokeMissing": "Tauri invoke API unavailable, cannot start WebRTC test.",
    "info.webrtcSenderStarted": "WebRTC sender started, waiting for receiver.",
    "info.needPairingForWebrtc": "Enter a pairing code before starting WebRTC receive.",
    "info.webrtcReceiverStarted": "WebRTC receiver started, waiting for sender.",
    "info.deviceUpdateTauriOnly": "Device updates are only available in the desktop app.",
    "info.fieldCopied": "{field} copied to clipboard.",
    "info.deviceUpdated": "Device updated.",
    "info.syncTauriOnly": "Resync requires the desktop app.",
    "info.noIdentityToRemove": "No identity to remove.",
    "info.identityRemoved": "Identity removed from this device. Import it again next time.",
    "info.transferComplete": "Transfer complete. PoT generated.",
    "license.current": "Current plan",
    "license.quota": "Cross-network quota",
    "license.quotaUsage": "{used} of {quota} uses consumed",
    "license.empty": "No license data yet. Try refreshing.",
    "license.placeholder": "Enter License Key, e.g. QD-PRO-XXXX-YYYY",
    "stats.emptyTransfers": "No transfers yet.",
    "audit.empty": "No audit entries.",
    "settings.security.signature": "Signature verification",
    "settings.security.enabledRecommended": "Enabled (recommended)",
    "settings.security.disabled": "Disabled",
    "settings.security.disconnect": "Drop on verification failure",
    "settings.security.disconnect.strict": "Fail fast",
    "settings.security.disconnect.warn": "Warn only",
    "settings.security.audit": "Audit log",
    "settings.security.audit.enabled": "Persisted to local SQLite",
    "settings.security.audit.disabled": "Not recorded",
    "settings.security.empty": "Unable to load security policies. Please refresh or check your config.",
    "trusted.clear": "Clear",
    "trusted.unknownFingerprint": "Unknown fingerprint",
    "trusted.status.verified": "Verified",
    "trusted.status.manual": "Manually trusted",
    "trusted.remove": "Remove",
    "settings.chunk.adaptive": "Adaptive chunking",
    "settings.chunk.min": "Min chunk (MiB)",
    "settings.chunk.max": "Max chunk (MiB)",
    "settings.chunk.streams": "LAN parallel streams",
    "settings.chunk.help": "Automatically adjusts chunk size based on network quality.",
    "settings.chunk.save": "Save settings",
    "settings.chunk.saving": "Saving…",
    "settings.chunk.empty": "No settings available yet. Refresh and try again.",
    "locale.label": "Language",
    "locale.zh": "中文",
    "locale.en": "English",
    "nav.send": "Send Files",
    "nav.receive": "Receive Files",
    "nav.identity": "Identity",
    "nav.transfer": "Transfer Status",
    "nav.webrtc": "WebRTC Lab",
    "nav.logs": "Event Logs",
    "nav.control": "Control Panel",
    "transfer.tab.basic": "Basic Info",
    "transfer.tab.monitor": "Monitoring",
    "transfer.tab.stats": "Statistics",
    "transfer.tab.audit": "Audit Logs",
    "transfer.tab.security": "Security",
    "transfer.tab.settings": "Settings",
    "control.transferHeading": "Transfer Status",
    "control.transferEmpty": "No active transfer.",
    "control.logsHeading": "Event Logs",
    "control.logsEmpty": "No logs yet.",
    "identity.heading": "Identity & Devices",
    "identity.identityLabel": "Identity ID",
    "identity.primaryKey": "Primary Public Key",
    "identity.empty": "No identity yet. Click “Create Primary Identity” to create one.",
    "identity.activeDevice": "Active device: {name}",
    "identity.browserHint": "Running in browser preview mode. Identity actions will guide you to the desktop app.",
    "identity.actions.createPrimary": "Create Primary Identity",
    "identity.actions.creating": "Creating…",
    "identity.actions.registerDevice": "Register New Device",
    "identity.actions.registering": "Registering…",
    "identity.actions.export": "Export Private Key",
    "identity.actions.forget": "Forget Identity",
    "identity.actions.forgetting": "Removing…",
    "identity.actions.sync": "Resync",
    "identity.actions.upgrade": "Upgrade to PRO",
    "identity.actions.downgrade": "Downgrade to Free",
    "identity.actions.updating": "Updating…",
    "identity.import.idPlaceholder": "Identity ID",
    "identity.import.keyPlaceholder": "Private key (hex)",
    "identity.import.submit": "Import Identity",
    "identity.import.submitting": "Importing…",
    "identity.entitlement.label": "Current plan",
    "identity.entitlement.plan.free": "free",
    "identity.entitlement.plan.pro": "pro",
    "identity.entitlement.plan.enterprise": "enterprise",
    "identity.devices.empty": "No devices registered yet.",
    "identity.devices.emptyNoIdentity": "Create an identity to see your devices here.",
    "identity.devices.lastSeen": "Last heartbeat {time}",
    "identity.devices.capabilities": "Capabilities {list}",
    "identity.devices.activeFlag": "Current device",
    "identity.device.section": "Device settings",
    "identity.device.nameLabel": "Device name",
    "identity.device.namePlaceholder": "e.g. Workstation, Laptop",
    "identity.device.statusLabel": "Device status",
    "identity.device.status.active": "active · Online",
    "identity.device.status.standby": "standby · Waiting",
    "identity.device.status.inactive": "inactive · Offline",
    "identity.device.save": "Save device",
    "identity.device.saving": "Saving…",
    "identity.device.setStandby": "Set Standby",
    "identity.device.markInactive": "Mark Inactive",
    "identity.device.hint": "Updates are signed via auth_update_device. Keep names consistent to switch between devices easily.",
    "webrtc.heading": "WebRTC Lab (Phase III)",
    "webrtc.hint": "If no pairing code is provided, the sender generates a random 6-digit code. The receiver reuses the pairing code and save directory from the Receive panel. This feature is experimental and validates the P2P signaling flow.",
    "webrtc.startSender": "Start WebRTC Sender",
    "webrtc.senderStarting": "Starting WebRTC sender…",
    "webrtc.startReceiver": "Start WebRTC Receiver",
    "webrtc.receiverStarting": "Waiting for WebRTC receiver…",
    "webrtc.receiverDisabled": "WebRTC receive testing is disabled in this build. Use the Control Panel to download delivered files.",
    "stats.totalTransfers": "Total transfers",
    "stats.totalBytes": "Total bytes",
    "stats.successRate": "Success rate",
    "stats.successFailure": "Succeeded {succ} · Failed {fail}",
    "receive.panel.title": "Receive Files",
    "receive.panel.codeSection": "Pairing Code",
    "receive.panel.connect": "Connect",
    "receive.panel.connecting": "Connecting…",
    "receive.panel.nearby": "Nearby Devices",
    "receive.panel.bleDevice": "BLE Device",
    "receive.panel.noDevices": "No BLE devices found nearby",
    "receive.panel.connectSuccess": "Connected, ready to receive…",
    "receive.panel.connectError": "Connection failed: {error}",
  },
};

type LocaleKey = keyof typeof DEFAULT_MESSAGES;

export const SUPPORTED_LOCALES: Array<{
  value: LocaleKey;
  labelKey: string;
  fallback: string;
}> = [
  { value: "zh-CN", labelKey: "locale.zh", fallback: "中文" },
  { value: "en", labelKey: "locale.en", fallback: "English" },
];

const isLocaleKey = (value: string): value is LocaleKey => value in DEFAULT_MESSAGES;

const detectSystemLocale = (): LocaleKey => {
  if (typeof navigator === "undefined") {
    return DEFAULT_LOCALE;
  }
  // 检测系统语言，优先使用 navigator.languages
  const languages = navigator.languages ?? [navigator.language];
  for (const lang of languages) {
    const lower = lang.toLowerCase();
    // 中文系统（zh, zh-CN, zh-TW, zh-HK 等）使用中文
    if (lower.startsWith("zh")) {
      return "zh-CN";
    }
    // 英文系统使用英文
    if (lower.startsWith("en")) {
      return "en";
    }
  }
  // 其他语言默认使用中文（照顾国内用户）
  return DEFAULT_LOCALE;
};

const getInitialLocale = (): LocaleKey => {
  if (typeof window === "undefined") {
    return DEFAULT_LOCALE;
  }
  // 优先使用用户手动设置的语言
  const stored = window.localStorage.getItem(LOCALE_STORAGE_KEY);
  if (stored && isLocaleKey(stored)) {
    return stored;
  }
  // 否则检测系统语言
  return detectSystemLocale();
};

const I18nContext = createContext<I18nContextValue>({
  locale: DEFAULT_LOCALE,
  setLocale: () => undefined,
  t: (_key, fallback) => fallback ?? "",
});

export const I18nProvider = ({ children }: { children: ReactNode }) => {
  const [locale, setLocaleState] = useState<LocaleKey>(getInitialLocale);

  useEffect(() => {
    if (typeof window !== "undefined") {
      window.localStorage.setItem(LOCALE_STORAGE_KEY, locale);
    }
  }, [locale]);

  const handleSetLocale = useCallback((next: string) => {
    if (isLocaleKey(next)) {
      setLocaleState(next);
    }
  }, []);

  const translate = useCallback(
    (key: string, fallback?: string, params?: TranslateParams) => {
      const template = DEFAULT_MESSAGES[locale]?.[key] ?? fallback ?? key;
      if (!params) {
        return template;
      }
      return Object.entries(params).reduce((acc, [token, value]) => {
        const pattern = new RegExp(`\\{${token}\\}`, "g");
        return acc.replace(pattern, String(value));
      }, template);
    },
    [locale],
  );

  const value = useMemo<I18nContextValue>(
    () => ({
      locale,
      setLocale: handleSetLocale,
      t: translate,
    }),
    [locale, handleSetLocale, translate],
  );

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
};

export const useI18n = () => useContext(I18nContext);
